<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio: Big Data con PySpark - Sesion 09</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .code-block { font-family: 'Fira Code', 'Consolas', monospace; }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 to-blue-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Pasos del laboratorio
        const labSteps = [
            {
                id: 1,
                title: 'Contexto del Caso',
                duration: '10 min',
                icon: 'üìã',
                content: {
                    description: `TelcoMovil Panama es una empresa de telecomunicaciones con 2 millones de clientes.
                    Generan 50GB de registros de llamadas (CDRs) diarios y necesitan analizar patrones de uso
                    para detectar fraude y optimizar la red.`,
                    challenge: 'Los datos son demasiado grandes para Excel o SQL tradicional.',
                    objective: 'Implementar un pipeline de analisis usando PySpark en Google Colab.',
                    dataset: {
                        name: 'cdrs_telcomovil.csv (simulado)',
                        records: '500,000 registros',
                        columns: ['call_id', 'origen', 'destino', 'fecha_hora', 'duracion_seg', 'tipo', 'costo', 'torre_id', 'plan_cliente']
                    }
                }
            },
            {
                id: 2,
                title: 'Configurar Entorno',
                duration: '15 min',
                icon: '‚öôÔ∏è',
                content: {
                    instruction: 'Crear un notebook en Google Colab e instalar PySpark.',
                    code: `# Celda 1: Instalar PySpark en Colab
!pip install pyspark

# Celda 2: Imports y configuracion
from pyspark.sql import SparkSession
from pyspark.sql.functions import *
from pyspark.sql.types import *
import matplotlib.pyplot as plt

# Crear sesion de Spark
spark = SparkSession.builder \\
    .appName("TelcoMovil-BigData") \\
    .config("spark.sql.shuffle.partitions", "8") \\
    .getOrCreate()

# Verificar version
print(f"Spark version: {spark.version}")
print(f"Ejecutores: {spark.sparkContext.defaultParallelism}")`,
                    tips: [
                        'Colab provee ~12GB RAM y 2 CPUs gratis',
                        'Para datos reales usarias un cluster EMR o Databricks',
                        'shuffle.partitions=8 es para datos pequenos en Colab'
                    ]
                }
            },
            {
                id: 3,
                title: 'Generar Dataset Simulado',
                duration: '15 min',
                icon: 'üìä',
                content: {
                    instruction: 'Crear datos sinteticos que simulen CDRs de telecomunicaciones.',
                    code: `# Celda 3: Generar datos simulados de CDRs
import random
from datetime import datetime, timedelta

# Configuracion
NUM_RECORDS = 500000
torres = [f"TWR-{str(i).zfill(3)}" for i in range(1, 51)]  # 50 torres
planes = ['Prepago', 'Postpago-Basico', 'Postpago-Premium', 'Empresarial']
tipos_llamada = ['Local', 'Larga-Distancia', 'Internacional', 'Roaming']

# Generar datos
data = []
base_date = datetime(2026, 1, 1)

for i in range(NUM_RECORDS):
    # Simular patrones: mas llamadas en horas pico, algunas anomalias
    hora = random.choices(range(24), weights=[2,1,1,1,2,3,5,8,10,10,9,8,7,8,9,10,10,9,8,7,5,4,3,2])[0]

    duracion = random.expovariate(1/180)  # Media 3 minutos
    if random.random() < 0.001:  # 0.1% anomalias (fraude potencial)
        duracion = random.randint(3600, 7200)  # 1-2 horas

    tipo = random.choice(tipos_llamada)
    costo_base = {'Local': 0.05, 'Larga-Distancia': 0.15, 'Internacional': 0.50, 'Roaming': 0.75}

    data.append((
        f"CALL-{str(i+1).zfill(8)}",
        f"+507-{random.randint(6000,6999)}-{random.randint(1000,9999)}",
        f"+507-{random.randint(6000,6999)}-{random.randint(1000,9999)}",
        (base_date + timedelta(days=random.randint(0,30), hours=hora, minutes=random.randint(0,59))).isoformat(),
        int(duracion),
        tipo,
        round(duracion * costo_base[tipo] / 60, 2),
        random.choice(torres),
        random.choice(planes)
    ))

# Crear DataFrame de Spark
schema = StructType([
    StructField("call_id", StringType(), False),
    StructField("origen", StringType(), False),
    StructField("destino", StringType(), False),
    StructField("fecha_hora", StringType(), False),
    StructField("duracion_seg", IntegerType(), False),
    StructField("tipo", StringType(), False),
    StructField("costo", DoubleType(), False),
    StructField("torre_id", StringType(), False),
    StructField("plan_cliente", StringType(), False)
])

df = spark.createDataFrame(data, schema)
df = df.withColumn("fecha_hora", to_timestamp("fecha_hora"))

print(f"Total registros: {df.count():,}")
df.printSchema()
df.show(5, truncate=False)`,
                    explanation: 'Generamos 500K registros con patrones realistas: distribucion de llamadas por hora, duraciones exponenciales y algunas anomalias para detectar fraude.'
                }
            },
            {
                id: 4,
                title: 'Analisis Exploratorio con Spark',
                duration: '20 min',
                icon: 'üîç',
                content: {
                    instruction: 'Realizar EDA usando Spark SQL y funciones de agregacion.',
                    code: `# Celda 4: Estadisticas basicas
print("=== ESTADISTICAS BASICAS ===")
df.describe("duracion_seg", "costo").show()

# Registrar como tabla SQL
df.createOrReplaceTempView("cdrs")

# Query 1: Llamadas por tipo
print("\\n=== LLAMADAS POR TIPO ===")
spark.sql("""
    SELECT tipo,
           COUNT(*) as num_llamadas,
           ROUND(AVG(duracion_seg)/60, 2) as duracion_prom_min,
           ROUND(SUM(costo), 2) as ingresos_total
    FROM cdrs
    GROUP BY tipo
    ORDER BY num_llamadas DESC
""").show()

# Query 2: Trafico por hora del dia
print("\\n=== TRAFICO POR HORA ===")
trafico_hora = spark.sql("""
    SELECT HOUR(fecha_hora) as hora,
           COUNT(*) as llamadas,
           ROUND(SUM(costo), 2) as ingresos
    FROM cdrs
    GROUP BY HOUR(fecha_hora)
    ORDER BY hora
""")
trafico_hora.show(24)

# Query 3: Top 10 torres con mas trafico
print("\\n=== TOP 10 TORRES ===")
spark.sql("""
    SELECT torre_id,
           COUNT(*) as llamadas,
           COUNT(DISTINCT origen) as usuarios_unicos
    FROM cdrs
    GROUP BY torre_id
    ORDER BY llamadas DESC
    LIMIT 10
""").show()`,
                    tips: [
                        'Spark SQL permite queries familiares sobre DataFrames',
                        'createOrReplaceTempView registra el DF como tabla temporal',
                        'Las transformaciones son lazy - se ejecutan con acciones (show, count)'
                    ]
                }
            },
            {
                id: 5,
                title: 'Deteccion de Anomalias',
                duration: '25 min',
                icon: 'üö®',
                content: {
                    instruction: 'Identificar llamadas sospechosas que podrian indicar fraude.',
                    code: `# Celda 5: Deteccion de anomalias
from pyspark.sql.window import Window

# Calcular estadisticas por usuario
stats_usuario = df.groupBy("origen").agg(
    count("*").alias("total_llamadas"),
    avg("duracion_seg").alias("duracion_promedio"),
    stddev("duracion_seg").alias("duracion_std"),
    sum("costo").alias("gasto_total")
)

# Definir umbrales de anomalia
# Llamada anomala: duracion > promedio + 3*std del usuario
df_con_stats = df.join(stats_usuario.select("origen", "duracion_promedio", "duracion_std"), on="origen")

anomalias = df_con_stats.filter(
    (col("duracion_seg") > col("duracion_promedio") + 3 * col("duracion_std")) &
    (col("duracion_seg") > 1800)  # Al menos 30 minutos
)

print(f"Llamadas anomalas detectadas: {anomalias.count()}")
anomalias.select(
    "call_id", "origen", "duracion_seg", "tipo", "costo", "torre_id"
).orderBy(desc("duracion_seg")).show(10)

# Usuarios con comportamiento sospechoso
usuarios_sospechosos = anomalias.groupBy("origen").agg(
    count("*").alias("llamadas_anomalas"),
    sum("costo").alias("costo_anomalo")
).filter(col("llamadas_anomalas") >= 2).orderBy(desc("costo_anomalo"))

print(f"\\nUsuarios sospechosos (2+ anomalias): {usuarios_sospechosos.count()}")
usuarios_sospechosos.show()`,
                    explanation: 'Usamos estadistica descriptiva (media + 3 desviaciones estandar) para detectar outliers. En produccion, usarias ML mas sofisticado.'
                }
            },
            {
                id: 6,
                title: 'Agregaciones para Data Warehouse',
                duration: '20 min',
                icon: 'üì¶',
                content: {
                    instruction: 'Crear tablas agregadas para cargar a un Data Warehouse.',
                    code: `# Celda 6: Crear tablas agregadas para DW

# Fact table: Resumen diario por torre y tipo
fact_trafico_diario = df.withColumn("fecha", to_date("fecha_hora")).groupBy(
    "fecha", "torre_id", "tipo", "plan_cliente"
).agg(
    count("*").alias("num_llamadas"),
    sum("duracion_seg").alias("duracion_total_seg"),
    sum("costo").alias("ingresos"),
    countDistinct("origen").alias("usuarios_unicos")
)

print("=== FACT_TRAFICO_DIARIO ===")
print(f"Registros: {fact_trafico_diario.count():,}")
fact_trafico_diario.show(10)

# Dim: Torres con metricas
dim_torres = df.groupBy("torre_id").agg(
    count("*").alias("total_llamadas_historico"),
    countDistinct("origen").alias("usuarios_unicos"),
    avg("duracion_seg").alias("duracion_promedio")
).withColumn("categoria_torre",
    when(col("total_llamadas_historico") > 15000, "Alta-Demanda")
    .when(col("total_llamadas_historico") > 8000, "Media-Demanda")
    .otherwise("Baja-Demanda")
)

print("\\n=== DIM_TORRES ===")
dim_torres.show(10)

# Guardar como Parquet (formato columnar optimo para analytics)
fact_trafico_diario.write.mode("overwrite").parquet("/content/fact_trafico_diario")
dim_torres.write.mode("overwrite").parquet("/content/dim_torres")

print("\\nArchivos Parquet guardados exitosamente!")`,
                    tips: [
                        'Parquet es el formato estandar para Data Lakes',
                        'Compresion columnar reduce almacenamiento 10x',
                        'Spark puede leer Parquet directamente desde S3/GCS'
                    ]
                }
            },
            {
                id: 7,
                title: 'Visualizacion y Conclusiones',
                duration: '15 min',
                icon: 'üìà',
                content: {
                    instruction: 'Crear visualizaciones con los datos agregados y documentar hallazgos.',
                    code: `# Celda 7: Visualizaciones

# Convertir a Pandas para graficos (datos agregados son pequenos)
trafico_pd = trafico_hora.toPandas()

fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Grafico 1: Llamadas por hora
axes[0].bar(trafico_pd['hora'], trafico_pd['llamadas'], color='steelblue')
axes[0].set_xlabel('Hora del Dia')
axes[0].set_ylabel('Numero de Llamadas')
axes[0].set_title('Distribucion de Trafico por Hora')
axes[0].axhline(y=trafico_pd['llamadas'].mean(), color='red', linestyle='--', label='Promedio')
axes[0].legend()

# Grafico 2: Ingresos por hora
axes[1].plot(trafico_pd['hora'], trafico_pd['ingresos'], marker='o', color='green')
axes[1].set_xlabel('Hora del Dia')
axes[1].set_ylabel('Ingresos ($)')
axes[1].set_title('Ingresos por Hora')
axes[1].fill_between(trafico_pd['hora'], trafico_pd['ingresos'], alpha=0.3, color='green')

plt.tight_layout()
plt.savefig('/content/analisis_trafico.png', dpi=150)
plt.show()

# Resumen ejecutivo
print("\\n" + "="*50)
print("RESUMEN EJECUTIVO - TelcoMovil Panama")
print("="*50)
print(f"Total de llamadas analizadas: {df.count():,}")
print(f"Periodo: Enero 2026")
print(f"Anomalias detectadas: {anomalias.count()} ({anomalias.count()/df.count()*100:.2f}%)")
print(f"Torres de alta demanda: {dim_torres.filter(col('categoria_torre')=='Alta-Demanda').count()}")
print(f"\\nHoras pico: 9-11 AM y 4-6 PM")
print(f"Tipo de llamada mas comun: Local")
print(f"\\nRecomendaciones:")
print("1. Investigar usuarios con multiples llamadas anomalas")
print("2. Reforzar capacidad en torres de alta demanda")
print("3. Implementar alertas real-time para duraciones > 1 hora")`,
                    deliverable: 'Notebook completado con analisis y visualizaciones exportadas.'
                }
            }
        ];

        function App() {
            const [currentStep, setCurrentStep] = useState(1);
            const [completedSteps, setCompletedSteps] = useState([]);
            const [showCode, setShowCode] = useState(true);

            const currentStepData = labSteps.find(s => s.id === currentStep);

            const markCompleted = (stepId) => {
                if (!completedSteps.includes(stepId)) {
                    setCompletedSteps([...completedSteps, stepId]);
                }
            };

            const progress = (completedSteps.length / labSteps.length) * 100;

            return (
                <div className="max-w-5xl mx-auto p-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-sky-600 to-blue-600 text-white p-6 rounded-xl shadow-lg mb-6">
                        <div className="flex items-center gap-2 text-sky-100 mb-2">
                            <a href="../" className="hover:text-white">‚Üê Inicio</a>
                            <span>/</span>
                            <a href="index.html" className="hover:text-white">Sesion 09</a>
                        </div>
                        <h1 className="text-2xl font-bold mb-2">Laboratorio: Big Data con PySpark</h1>
                        <p className="text-sky-100">Analisis de CDRs de telecomunicaciones a escala</p>
                        <div className="mt-4 flex items-center gap-4">
                            <span className="bg-sky-500 px-3 py-1 rounded-full text-sm">Google Colab</span>
                            <span className="bg-sky-500 px-3 py-1 rounded-full text-sm">PySpark</span>
                            <span className="bg-sky-500 px-3 py-1 rounded-full text-sm">~2 horas</span>
                        </div>
                    </div>

                    {/* Progress bar */}
                    <div className="bg-white rounded-xl p-4 shadow mb-6">
                        <div className="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Progreso del laboratorio</span>
                            <span>{completedSteps.length}/{labSteps.length} pasos</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div
                                className="h-full bg-gradient-to-r from-sky-500 to-blue-500 transition-all duration-500"
                                style={{ width: `${progress}%` }}
                            />
                        </div>
                    </div>

                    <div className="grid lg:grid-cols-4 gap-6">
                        {/* Steps sidebar */}
                        <div className="lg:col-span-1">
                            <div className="bg-white rounded-xl shadow p-4">
                                <h3 className="font-bold text-gray-800 mb-3">Pasos</h3>
                                <div className="space-y-2">
                                    {labSteps.map(step => (
                                        <button
                                            key={step.id}
                                            onClick={() => setCurrentStep(step.id)}
                                            className={`w-full text-left p-3 rounded-lg transition-all ${
                                                currentStep === step.id
                                                    ? 'bg-sky-100 border-2 border-sky-500'
                                                    : completedSteps.includes(step.id)
                                                    ? 'bg-green-50 border border-green-300'
                                                    : 'bg-gray-50 hover:bg-gray-100'
                                            }`}
                                        >
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg">{step.icon}</span>
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-sm font-medium truncate">{step.title}</div>
                                                    <div className="text-xs text-gray-500">{step.duration}</div>
                                                </div>
                                                {completedSteps.includes(step.id) && (
                                                    <span className="text-green-500">‚úì</span>
                                                )}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Main content */}
                        <div className="lg:col-span-3">
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex items-center gap-3">
                                        <span className="text-3xl">{currentStepData.icon}</span>
                                        <div>
                                            <h2 className="text-xl font-bold text-gray-800">
                                                Paso {currentStep}: {currentStepData.title}
                                            </h2>
                                            <span className="text-sm text-gray-500">{currentStepData.duration}</span>
                                        </div>
                                    </div>
                                    {currentStepData.content.code && (
                                        <button
                                            onClick={() => setShowCode(!showCode)}
                                            className="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200"
                                        >
                                            {showCode ? 'Ocultar' : 'Mostrar'} codigo
                                        </button>
                                    )}
                                </div>

                                {/* Step 1: Context */}
                                {currentStep === 1 && (
                                    <div className="space-y-4">
                                        <div className="bg-sky-50 p-4 rounded-lg">
                                            <h4 className="font-bold text-sky-800 mb-2">Caso de Estudio</h4>
                                            <p className="text-gray-700">{currentStepData.content.description}</p>
                                        </div>

                                        <div className="bg-amber-50 border-l-4 border-amber-500 p-4">
                                            <h4 className="font-bold text-amber-800">Desafio</h4>
                                            <p className="text-gray-700">{currentStepData.content.challenge}</p>
                                        </div>

                                        <div className="bg-green-50 p-4 rounded-lg">
                                            <h4 className="font-bold text-green-800 mb-2">Objetivo</h4>
                                            <p className="text-gray-700">{currentStepData.content.objective}</p>
                                        </div>

                                        <div className="border rounded-lg p-4">
                                            <h4 className="font-bold mb-2">Dataset</h4>
                                            <p className="text-sm text-gray-600 mb-2">
                                                <strong>{currentStepData.content.dataset.name}</strong> - {currentStepData.content.dataset.records}
                                            </p>
                                            <div className="flex flex-wrap gap-2">
                                                {currentStepData.content.dataset.columns.map((col, i) => (
                                                    <span key={i} className="bg-gray-100 px-2 py-1 rounded text-sm">{col}</span>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Steps 2-7: Code steps */}
                                {currentStep > 1 && (
                                    <div className="space-y-4">
                                        {currentStepData.content.instruction && (
                                            <div className="bg-sky-50 p-4 rounded-lg">
                                                <p className="text-gray-700">{currentStepData.content.instruction}</p>
                                            </div>
                                        )}

                                        {showCode && currentStepData.content.code && (
                                            <div className="bg-gray-900 text-gray-100 p-4 rounded-xl overflow-x-auto">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-gray-400 text-sm">Python (PySpark)</span>
                                                    <button
                                                        onClick={() => navigator.clipboard.writeText(currentStepData.content.code)}
                                                        className="text-gray-400 hover:text-white text-sm"
                                                    >
                                                        Copiar
                                                    </button>
                                                </div>
                                                <pre className="code-block text-sm whitespace-pre-wrap">{currentStepData.content.code}</pre>
                                            </div>
                                        )}

                                        {currentStepData.content.explanation && (
                                            <div className="bg-purple-50 border-l-4 border-purple-500 p-4">
                                                <p className="text-gray-700">{currentStepData.content.explanation}</p>
                                            </div>
                                        )}

                                        {currentStepData.content.tips && (
                                            <div className="bg-amber-50 p-4 rounded-lg">
                                                <h4 className="font-bold text-amber-800 mb-2">Tips</h4>
                                                <ul className="text-sm text-gray-700 space-y-1">
                                                    {currentStepData.content.tips.map((tip, i) => (
                                                        <li key={i}>‚Ä¢ {tip}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {currentStepData.content.deliverable && (
                                            <div className="bg-green-50 border-2 border-green-300 p-4 rounded-lg">
                                                <h4 className="font-bold text-green-800 mb-1">Entregable</h4>
                                                <p className="text-gray-700">{currentStepData.content.deliverable}</p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Navigation buttons */}
                                <div className="flex justify-between mt-8 pt-4 border-t">
                                    <button
                                        onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
                                        disabled={currentStep === 1}
                                        className={`px-4 py-2 rounded-lg ${
                                            currentStep === 1
                                                ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        ‚Üê Anterior
                                    </button>

                                    <button
                                        onClick={() => {
                                            markCompleted(currentStep);
                                            if (currentStep < labSteps.length) {
                                                setCurrentStep(currentStep + 1);
                                            }
                                        }}
                                        className="bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700"
                                    >
                                        {currentStep === labSteps.length ? 'Completar Lab' : 'Marcar completado ‚Üí'}
                                    </button>
                                </div>
                            </div>

                            {/* Completion message */}
                            {completedSteps.length === labSteps.length && (
                                <div className="mt-6 bg-green-100 border-2 border-green-500 p-6 rounded-xl text-center">
                                    <div className="text-4xl mb-2">üéâ</div>
                                    <h3 className="text-xl font-bold text-green-800 mb-2">Laboratorio Completado</h3>
                                    <p className="text-gray-700 mb-4">
                                        Has aprendido a procesar datos a gran escala con PySpark.
                                    </p>
                                    <div className="flex justify-center gap-4">
                                        <a href="ejercicio-individual.html" className="bg-violet-600 text-white px-6 py-2 rounded-lg hover:bg-violet-700">
                                            Ejercicio Individual ‚Üí
                                        </a>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="mt-8 text-center text-gray-500 text-sm">
                        <p>Sesion 09 - Laboratorio Big Data</p>
                        <p>ADEN University - Cuatrimestre I 2026</p>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
